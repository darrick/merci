<?php
// $Id$


/**
 * @file
 * Hooks and functions for MERCI Inventory
 */

/**
 * Implements hook_menu().
 */
function merci_inventory_menu() {

  $items = array();

  foreach (array_keys(node_type_get_types()) as $type_name) {

    $type_url_str = str_replace('_', '-', $type_name);

    $items['admin/content/node-type/' . $type_url_str . '/merci_inventory'] = array(
      'title' => 'MERCI Inventory',
      'page callback' => 'merci_inventory_admin_page',
      'page arguments' => array($type_name),
      'access callback' => 'merci_inventory_node_type_menu_access',
      'access arguments' => array($type_name),
      'type' => MENU_LOCAL_TASK,
      'weight' => 10,
    );
  }
  // foreach

  return $items;
}
// merci_inventory_menu

/**
 * Access check
 */
function merci_inventory_node_type_menu_access($type_name) {

  $types = merci_inventory_sync_resource_types();

  if ((!in_array($type_name, $types)) && user_access('administer MERCI')) {
    return TRUE;
  }
  // if

  return FALSE;
}
// merci_inventory_node_type_menu_access

/**
 * Menu callback; sync fields
 */
function merci_inventory_admin_page($type_name = NULL) {

  $html .= '<h2>Sync Inventory Fields</h2>';
  $html .= drupal_get_form('merci_inventory_sync_fields', $type_name);

  return $html;
}
// merci_inventory_admin_page

/**
 * Field sync form
 */
function merci_inventory_sync_fields($form, &$form_state, $type_name) {

  $form = array();

  $form['merci_inventory_type'] = array(
    '#type' => 'hidden',
    '#value' => $type_name,
  );

  $form['merci_inventory_sync_to_types'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Sync fields from') . ' <i>' . $type_name . '</i> ' . t('to these types'),
    '#options' => array(),
  );

  $types = merci_inventory_sync_resource_types();

  foreach ($types as $type) {
    $form['merci_inventory_sync_to_types']['#options'][$type] = $type;
  }
  // foreach

  $form['merci_inventory_submit'] = array(
    '#type' => 'submit',
    '#value' => t('Sync Fields'),
  );
  $form['#submit'] = array('merci_inventory_sync_fields_submit');

  return $form;
}
// merci_inventory_sync_fields

/**
 * Field sync form submission handler
 */
function merci_inventory_sync_fields_submit($form_id, $form_values) {

  module_load_include('inc', 'content', 'includes/content.crud');

  $added = 0;

  $values    = $form_values['values'];
  $base_type = $values['merci_inventory_type'];
  $params    = array('type_name' => $base_type);

  $fields = content_field_instance_read($params);

  // Sync groups if fieldgroup module is enabled

  if (module_exists('fieldgroup')) {
    $groups = fieldgroup_groups($base_type);
  }
  // if
  else {
    $groups = array();
  }
  // else

  $new_fields = array();
  $update_fields = array();

  foreach ($values['merci_inventory_sync_to_types'] as $type => $value) {

    if ($value !== 0) {

      foreach ($fields as $field) {

        $field['type_name'] = $type;

        $params['type_name'] = $type;
        $params['field_name'] = $field['field_name'];
        $field_exists = content_field_instance_read($params);

        if (count($field_exists) == 0) {

          // Sync field
          $new_fields[] = $field;

          //content_field_instance_create($field);
          drupal_set_message(t('%field_name was added to %type', array('%field_name' => $field['field_name'], '%type' => $type)));
          $added++;
        }
        // if
        else {

          // Update all weights (faster than checking for which weights need updating)

          $field_exists[0]['widget']['weight'] = $field['widget']['weight'] + 1000;
          $update_fields[] = $field_exists[0];
          //content_field_instance_update($field_exists[0]);
        }
        // else
      }
      // foreach
    }
  }
  // Update several fields at a time.
  foreach ($update_fields as $field) {
    content_field_instance_update($field, FALSE);
  }
  // Create several fields at a time.
  foreach ($new_fields as $field) {
    content_field_instance_create($field, FALSE);
  }

  // Clear caches and rebuild menu.
  content_clear_type_cache(TRUE);
  menu_rebuild();

  foreach ($values['merci_inventory_sync_to_types'] as $type => $value) {

    if ($value !== 0) {

      if (module_exists('fieldgroup')) {

        $existing_groups = fieldgroup_groups($type);

        foreach ($groups as $group_name => $group) {

          if (!isset($existing_groups[$group_name])) {

            // Add group

            fieldgroup_save_group($type, $group);
            drupal_set_message(t('%group_name was added to %type', array('%group_name' => $group_name, '%type' => $type)));
            $added++;

            $existing_groups = fieldgroup_groups($type, FALSE, TRUE);
          }
          // if
          else {

            // Update all weights

            // TODO Please convert this statement to the D7 database API syntax.
            db_query("UPDATE {" . fieldgroup_tablename() . "} SET weight = %d WHERE type_name = '%s' AND group_name = '%s'",
              $group['weight'] + 1000, $type, $group_name
            );
          }
          // else

          // Sync fields in group

          foreach ($group['fields'] as $field_name => $field) {

            if (!isset($existing_groups[$group_name]['fields'][$field_name])) {

              $group_field_params = array(
                'group' => $group_name,
                'field_name' => $field_name,
                'type_name' => $type,
              );

              fieldgroup_update_fields($group_field_params);

              drupal_set_message(t('%field_name was moved into group %group_name of %type', array('%field_name' => $field_name, '%group_name' => $group_name, '%type' => $type)));
              $added++;
            }
            // if
          }
          // foreach
        }
        // foreach
      }
      // if
    }
    // if
  }
  // foreach

  if ($added == 0) {
    drupal_set_message(t('No fields were synced, because all fields in %type are already synced in all selected types', array('%type' => $values['merci_inventory_type'])));
  }
  // if
}
// merci_inventory_sync_fields_submit
/**
 * @todo Please document this function.
 * @see http://drupal.org/node/1354
 */
function merci_inventory_sync_resource_types($reset = FALSE) {

  static $types = FALSE;

  if ((!is_array($types)) || $reset) {

    $types = array();
    $result = db_query("SELECT type FROM {merci_node_type} WHERE type_setting = :type_setting OR  type_setting = :type_setting", array(':type_setting' => 'resource', ':type_setting' => 'bucket'));

    while ($type = db_fetch_object($result)) {
      $types[] = $type->type;
    }
    // while
  }
  // if

  return $types;
}
// merci_inventory_sync_resource_types

