<?php

/**
 * Implements hook_node_info().
 */
function merci_reservation_node_info() {
  return array(
    // Reservation nodes.
    'merci_reservation' => array(
      'name' => t('Reservation'),
      'base' => 'merci_reservation',
      'has_body' => FALSE,
      'description' => t("A reservation reserves a resource or group of resources for some period of time."),
    ),
  );
}

/**
 * Implementation of hook_form().
 */
function merci_reservation_form($node, &$form_state) {
  return node_content_form($node, $form_state);
}

function merci_reservation_merci_settings_load($entity_type, $bundle, &$settings) {
  $settings['date_field'] = 'field_merci_date';
  $settings['target_field'] = 'field_merci_items'; 
}

function merci_reservation_form_alter(&$form, &$form_state, $form_id) {
}
/**
+ * Implements hook_field_widget_form_alter().
+ */
function merci_reservation_field_widget_multiple_selects_form_alter(&$element, &$form_state, $context) {
return;
  $entity      = $element['#entity'];
  $entity_type = $element['#entity_type'];
  $bundle      = $element['#bundle'];
  $langcode    = $element['#language'];
  $merci_settings = merci_settings_load($entity_type, $bundle);
  $target_field = $merci_settings['target_field'];
  $date_field = $merci_settings['date_field'];
  if ($target_field == $element['#field_name']) {

    $items = array();
    foreach ($element['target_id']['#options'] as $key => $value) {
      if ($key == "_none") { 
        continue; 
      }

      if (is_array($value)) {
        foreach ($value as $key2 => $value2) {
          $items[] = array('target_id' => $key2); 
        }
      } else {
          $items[] = array('target_id' => $key); 
      }
    }

    $errors = array();

    merci_resource_merci_validate_items($entity_type, $entity, $date_field, $target_field, $items, &$errors);
    foreach ($errors[$target_field][$langcode] as $delta => $value) {
      $target_id = $items[$delta]['target_id'];
      foreach ($element['target_id']['#options'] as $key => $value) {
        if ($key == "_none") { 
          continue; 
        }

        if (is_array($value)) {
          foreach ($value as $key2 => $value2) {
            if ($key2 == $target_id) {
              $element['target_id']['#disabled'][$key][$key2] = FALSE;
              break;
            }
          }
        } else {
          if ($key == $target_id) {
            $element['target_id']['#disabled'][$key] = FALSE;
          }
        }
      }
    }
    /*
    if (isset($element['#weight'])) {
      $current_weight = $element['#weight'];
      $col = key($context['field']['columns']);
      $current_value = isset($items[$current_weight]) ? $items[$current_weight][$col] : NULL;

      if (isset($instance['widget']['settings']['unique_option']) && $instance['widget']['settings']['unique_option']) 
        foreach ($items as $item) {
          if (is_array($item) && isset($item[$col]) && $item[$col]) {
            if ($current_weight != $item['_weight'] && $item[$col] != $current_value) {
              unset($element[$col]['#options'][$item[$col]]);
            }
          }
        }
      }
    }
     */
    dpm($element);
  }
}
